# yaml-language-server: $schema=https://raw.githubusercontent.com/zarf-dev/zarf/main/zarf.schema.json
kind: ZarfPackageConfig
metadata:
  name: supabase
  version: '###ZARF_PKG_TMPL_IMAGE_VERSION###'
  description: >
    supabase instance and all of its dependencies

constants:
  - name: DASHBOARD_USERNAME
    description: The dashboard's (Supabase studio) default username
    value: supabase-admin
  - name: EXTERNAL_KEYCLOAK_CLIENT_ID
    description: 'External keycloak client value'
    value: "uds-supabase"
  - name: IMAGE_VERSION
    value: '###ZARF_PKG_TMPL_IMAGE_VERSION###'

variables:
  - name: DOMAIN
    default: "uds.dev"
  - name: ENABLE_AUTH
    description: 'Enable Supabases built-in authentication and authorization parts'
    default: "true"
  - name: ENABLE_META
    description: 'Enable the restful API for managing Postgres, fetch tables, add roles, and run queries'
    default: "true"
  - name: ENABLE_REALTIME
    description: 'Enables the API for sending and receiving messages between clients in realtime in addition to listening for db changes'
    default: "true"
  - name: ENABLE_REST
    description: 'Enable the autogenerated high level rest API for interacting with the database'
    default: "true"
  - name: ENABLE_STORAGE
    description: 'Enable the Supabase object store'
    default: "true"
  - name: ENABLE_STUDIO
    description: 'Enable the dashboard for managing Supabase, this dashboard depends on and sits atop other Supabase components'
    default: "true"
  - name: ENABLE_VOLUME_PERMISSIONS
    description: 'Enable init container that changes the owner/group of the PV mount point to runAsUser:fsGroup'
    default: "false"
  - name: ENABLE_KONG
    description: 'Enable the API gateway that automatically handles the routing between the Supabase workloads'
    default: "true"
  - name: ENABLE_POSTGRES
    description: 'Enable built-in postgres db to store account information and serve as the backend db for integrating applications'
    default: "true"
  - name: ENABLE_EXTERNAL_KEYCLOAK
    description: 'Enable the integration between Supabase and an external keycloak instance be enabled'
    default: "true"
  - name: MAX_FILE_UPLOAD_SIZE_IN_BYTES
    description: 'The maximum upload file size for Supabase storage in bytes, default is equivalent to 512Mb'
    default: "536870912"

components:
  - name: supabase
    required: true
    only:
      flavor: upstream
    charts:
      - name: supabase
        namespace: leapfrogai
        url: https://github.com/supabase-community/supabase-kubernetes.git
        gitPath: charts/supabase
        releaseName: supabase
        version: 17e14e812fd60a7b5eedb56bf3b359f42ebf91a4
        valuesFiles:
          - "bitnami-values.yaml"
    images:
      - docker.io/supabase/gotrue:v2.143.0
      - docker.io/postgrest/postgrest:v12.0.1
      - docker.io/supabase/postgres:15.6.1.116
      - docker.io/supabase/postgres-meta:v0.80.0
      - docker.io/supabase/realtime:v2.27.5
      - docker.io/supabase/storage-api:v0.46.4
      - docker.io/supabase/studio:20240326-5e5586d
      - localhost:5000/test/custom-supabase-postgres:0.0.3
      - docker.io/postgres:15-alpine
      - docker.io/kong:2.8.1
      - docker.io/supabase/logflare:1.4.0
      - docker.io/darthsim/imgproxy:v3.8.0
      - docker.io/timberio/vector:0.34.0-alpine
      - localhost:5000/test/custom-supabase-vector:0.0.1

  - name: supabase-migrations
    description: "Migrations that operate on a database configuration level that require higher elevated permissions (ie adding extensions)"
    required: true
    only:
      flavor: upstream
    charts:
      - name: supabase-migrations
        namespace: leapfrogai
        localPath: migrationChart/
        releaseName: supabase-migrations
        version: 0.0.1
        valuesFiles:
          - "migration-values.yaml"
    images:
      - "ghcr.io/defenseunicorns/leapfrogai/supabase-migrations:###ZARF_PKG_TMPL_IMAGE_VERSION###"
    actions:
      onDeploy:
        after:
          - wait:
              cluster:
                kind: Job
                name: supabase-migrations-###ZARF_PKG_TMPL_IMAGE_VERSION###
                namespace: leapfrogai
                condition: complete